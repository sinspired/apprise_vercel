// PWA Service Worker 注册
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(reg => console.log('SW registered'))
            .catch(err => console.log('SW failed', err));
    });
}

// --- 国际化配置 (I18N) ---
const TRANSLATIONS = {
    "zh-CN": {
        app_title: "Apprise 通知",
        lang_switch_title: "切换语言",
        theme_switch_title: "切换主题",
        hint_copy_api: "点击复制 API 地址",
        hint_click_copy: "点击复制",
        label_urls: "目标 URLs (按回车或逗号添加)",
        link_examples: "示例",
        placeholder_urls: "tgram://..., mailto://...",
        label_type: "类型 TYPE",
        label_format: "格式 FORMAT",
        label_title: "标题 TITLE",
        placeholder_title: "Apprise 通知",
        label_body: "内容 BODY",
        placeholder_body: "来自 Apprise 控制台的测试通知",
        btn_send: "发送通知",
        btn_curl: "复制 cURL",
        header_response: "响应结果",
        header_history: "历史记录",
        btn_clear: "清空",
        msg_copied: "已复制!",
        msg_no_url: "请至少添加一个 URL 地址",
        msg_clear_history: "确定要清空历史记录吗？",
        opt_info: "Info",
        opt_success: "Success",
        opt_warning: "Warning",
        opt_error: "Error"
    },
    "en": {
        app_title: "Apprise Notify",
        lang_switch_title: "Switch Language",
        theme_switch_title: "Switch Theme",
        hint_copy_api: "Click to copy API URL",
        hint_click_copy: "Copy",
        label_urls: "Target URLs (Enter/Comma to add)",
        link_examples: "Samples",
        placeholder_urls: "tgram://..., mailto://...",
        label_type: "TYPE",
        label_format: "FORMAT",
        label_title: "TITLE",
        placeholder_title: "Apprise Notification",
        label_body: "BODY",
        placeholder_body: "Test notification from Apprise Console",
        btn_send: "Send",
        btn_curl: "Copy cURL",
        header_response: "Response",
        header_history: "History",
        btn_clear: "Clear",
        msg_copied: "Copied!",
        msg_no_url: "Please add at least one URL",
        msg_clear_history: "Are you sure you want to clear history?",
        opt_info: "Info",
        opt_success: "Success",
        opt_warning: "Warning",
        opt_error: "Error"
    },
    "ja": {
        app_title: "Apprise 通知",
        lang_switch_title: "言語切替",
        hint_copy_api: "クリックしてAPI URLをコピー",
        hint_click_copy: "コピー",
        label_urls: "通知先 URLs (Enter/カンマで追加)",
        link_examples: "例（れい）",
        placeholder_urls: "tgram://..., mailto://...",
        label_type: "タイプ TYPE",
        label_format: "フォーマット FORMAT",
        label_title: "タイトル TITLE",
        placeholder_title: "Apprise 通知",
        label_body: "本文 BODY",
        placeholder_body: "Apprise コンソールからのテスト通知",
        btn_send: "送信",
        btn_curl: "cURLをコピー",
        header_response: "レスポンス",
        header_history: "履歴",
        btn_clear: "クリア",
        msg_copied: "コピーしました!",
        msg_no_url: "URLを1つ以上追加してください",
        msg_clear_history: "履歴を消去してもよろしいですか？",
        opt_info: "Info",
        opt_success: "Success",
        opt_warning: "Warning",
        opt_error: "Error"
    }
};

// 显示名称映射
const LANG_NAMES = {
    "zh-CN": "简体中文",
    "en": "English",
    "ja": "日本語"
};

// --- 图标定义 ---
const Icons = {
    telegram: '<svg viewBox="0 0 22 22" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.48-1.02-2.42-1.63-1.09-.72-.38-1.11.24-1.74.14-.15 2.57-2.35 2.62-2.54.01-.02.01-.05 0-.07-.01-.02-.04-.03-.06-.03-.02 0-.2.12-.56.36L8.4 12.4c-.4.27-.78.41-1.15.4-.41-.01-1.2-.23-1.79-.42-.72-.24-.96-.37-.92-.78.02-.21.32-.43.89-.66 3.5-1.52 5.83-2.53 6.99-3.01 3.33-1.39 4.02-1.66 4.47-1.66.1 0 .32.02.47.14.12.1.16.23.17.33 0 .1 0 .23-.01.36z"/></svg>',
    x: '<svg role="img" viewBox="0 0 32 32" fill="currentColor"><title>X</title><path d="M14.234 10.162 22.977 0h-2.072l-7.591 8.824L7.251 0H.258l9.168 13.343L.258 24H2.33l8.016-9.318L16.749 24h6.993zm-2.837 3.299-.929-1.329L3.076 1.56h3.182l5.965 8.532.929 1.329 7.754 11.09h-3.182z"/></svg>',
    line: '<svg role="img" viewBox="0 0 24 24" fill="currentColor"><title>LINE</title><path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/></svg>',
    whatsapp: '<svg role="img" viewBox="0 0 24 24" fill="currentColor"><title>WhatsApp</title><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>',
    slack: '<svg class="prefix__icon" viewBox="0 0 1024 1024" fill="currentColor" width="200" height="200"><path d="M377.6 539.2c-59.2 0-107.2 48-107.2 107.2v268.8a107.2 107.2 0 00214.4 0V648c0-60.8-48-108.8-107.2-108.8zM0 648a107.2 107.2 0 00214.4 0V540.8H108.8C49.6 539.2 0 587.2 0 648zM377.6 0a107.2 107.2 0 000 214.4h107.2V107.2C484.8 48 436.8 0 377.6 0zM107.2 484.8H376a107.2 107.2 0 000-214.4H107.2a107.2 107.2 0 000 214.4zm808-214.4c-59.2 0-107.2 48-107.2 107.2v107.2h107.2a107.2 107.2 0 000-214.4zm-376-163.2v270.4a107.2 107.2 0 00214.4 0V107.2a107.2 107.2 0 00-214.4 0zm214.4 809.6c0-59.2-48-107.2-107.2-107.2H539.2v107.2a107.2 107.2 0 00214.4 0zm163.2-377.6H646.4a107.2 107.2 0 000 214.4h268.8c59.2 0 107.2-48 107.2-107.2 1.6-59.2-46.4-107.2-105.6-107.2z"/></svg>',
    mail: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>',
    discord: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.118.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/></svg>',
    bark: '<svg class="prefix__prefix__prefix__icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M198.567 0h624.045c104.527 21.308 170.716 83.713 198.56 187.213V833.95c-26.477 98.333-88.882 160.737-187.214 187.213H187.221C83.721 993.32 21.316 927.131.008 822.603V198.56C22.7 88.88 88.888 22.693 198.568 0z" fill="#FF3A2F" opacity=".996"/><path d="M187.221 351.734a1769.28 1769.28 0 01158.848 48.222 1346.739 1346.739 0 012.836 212.742 3639.03 3639.03 0 01-153.174 56.731c-10.734-1.571-18.296-7.244-22.693-17.019a3546.949 3546.949 0 010-283.657 59.687 59.687 0 0014.183-17.019z" fill="snow"/><path d="M805.592 357.407c16.254-2.524 30.437 1.254 42.549 11.346a3688.528 3688.528 0 010 289.33c-5.424 7.908-12.986 11.692-22.693 11.346a862.543 862.543 0 01-147.501-45.385 2048.397 2048.397 0 010-215.579 1786.877 1786.877 0 01127.645-51.058z" fill="#FFFCFC"/><path d="M136.163 402.792a871.557 871.557 0 010 198.56 741770.929 741770.929 0 00-73.75-158.848c.164-8.68 3.942-15.295 11.346-19.856a239.973 239.973 0 0162.404-19.856zm748.853 17.02a6240.103 6240.103 0 0173.75 161.684 35.701 35.701 0 01-5.672 17.02 1689.157 1689.157 0 00-73.75 25.528c-1.862-69.087.027-137.165 5.672-204.232z" fill="#FFFAF9"/><path d="M646.745 442.504H380.108v141.828h266.637a3271.246 3271.246 0 01-272.31 5.674V436.83c91.762-1.872 182.532.023 272.31 5.673z" fill="#FFB9B4"/><path d="M646.745 442.504v141.828H380.108V442.504h266.637z" fill="#FFFEFD"/><path d="M136.163 402.792c.34-3.08 2.23-4.97 5.673-5.673a973.68 973.68 0 010 209.906c-3.443-.704-5.333-2.593-5.673-5.673a871.557 871.557 0 000-198.56z" fill="#FF9993"/><path d="M885.016 419.812c-5.645 67.067-7.534 135.145-5.673 204.232-7.517-69.059-7.517-139.025 0-209.905 3.444.703 5.333 2.592 5.673 5.673z" fill="#FF857E"/></svg>',
    ntfy: '<svg role="img" viewBox="0 0 24 24" fill="currentColor"><title>ntfy</title><path d="M12.597 13.693v2.156h6.205v-2.156ZM5.183 6.549v2.363l3.591 1.901.023.01-.023.009-3.591 1.901v2.35l.386-.211 5.456-2.969V9.729ZM3.659 2.037C1.915 2.037.42 3.41.42 5.154v.002L.438 18.73 0 21.963l5.956-1.583h14.806c1.744 0 3.238-1.374 3.238-3.118V5.154c0-1.744-1.493-3.116-3.237-3.117h-.001zm0 2.2h17.104c.613.001 1.037.447 1.037.917v12.108c0 .47-.424.916-1.038.916H5.633l-3.026.915.031-.179-.017-13.76c0-.47.424-.917 1.038-.917z"/></svg>',
    qq: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M21.395 15.035a40 40 0 00-.803-2.264l-1.079-2.695c.001-.032.014-.562.014-.836C19.526 4.632 17.351 0 12 0S4.474 4.632 4.474 9.241c0 .274.013.804.014.836l-1.08 2.695a39 39 0 00-.802 2.264c-1.021 3.283-.69 4.643-.438 4.673.54.065 2.103-2.472 2.103-2.472 0 1.469.756 3.387 2.394 4.771-.612.188-1.363.479-1.845.835-.434.32-.379.646-.301.778.343.578 5.883.369 7.482.189 1.6.18 7.14.389 7.483-.189.078-.132.132-.458-.301-.778-.483-.356-1.233-.646-1.846-.836 1.637-1.384 2.393-3.302 2.393-4.771 0 0 1.563 2.537 2.103 2.472.251-.03.581-1.39-.438-4.673"/></svg>',
    wecom: '<svg t="1767201686596" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="26451" width="200" height="200"><path d="M700.8256 701.2864c26.88 26.9312 59.392 43.1104 95.4368 53.248l12.1344 3.1232c25.2928 4.608 38.5536 27.648 39.68 51.2 0 27.648-20.1216 51.2-47.7696 55.2448-26.4192 3.4304-54.0672-13.2608-59.8016-39.7312-8.0384-40.8064-25.344-76.4928-55.2448-106.3936-3.4304-3.4816-1.1264-10.9568-2.304-16.6912l13.4656-1.024c2.048 0 3.584 0.256 4.4032 1.024z m48.896-521.216c56.32 59.8016 87.4496 130.56 88.576 212.8384a109.2096 109.2096 0 0 0-45.4656-9.728h-2.304a109.2096 109.2096 0 0 0-104.0896 96.6144 120.2688 120.2688 0 0 0 0 28.7744c-20.1728 20.1216-44.9024 32.768-75.3664 37.9392h-0.6144a105.1648 105.1648 0 0 0-44.288 184.6784 416.3584 416.3584 0 0 1-106.4448 17.8688 481.3824 481.3824 0 0 1-137.472-13.2608 50.0224 50.0224 0 0 0-22.4256 2.304l-104.1408 51.2c-13.2608 6.912-25.344 8.0384-36.864-1.1264-10.9056-8.0896-12.032-20.1728-10.9056-34.56 4.608-28.7232 8.0896-57.4976 10.9568-86.272a31.1296 31.1296 0 0 0-8.0896-18.944c-45.4144-45.5168-84.5312-95.5392-104.0896-158.8224-36.864-125.44-3.4816-232.96 87.4496-322.7648C300.3904 3.9936 590.848 11.4688 749.7216 180.0704z m207.104 414.7712c28.7744 3.4816 50.0224 26.4704 50.0224 55.2448 0 27.648-16.6912 50.0224-44.288 55.2448-33.792 6.144-64.3072 20.48-89.7024 42.496l-9.216 8.704c-5.7856 5.7344-14.3872 10.9056-20.1728 2.304-2.304-4.608-1.1264-15.5648 2.304-18.9952a186.0096 186.0096 0 0 0 51.2-100.7104 54.784 54.784 0 0 1 59.8528-44.288z m-215.1936-51.7632c-1.1264 5.7344 1.1776 14.336-2.304 17.8176-28.7232 28.7744-44.288 63.2832-52.3264 103.0144-5.7856 28.7232-32.256 45.4144-59.8528 40.8064-27.648-4.608-48.3328-28.7744-48.3328-55.808 0-24.1664 17.8688-46.592 41.984-51.2a190.4128 190.4128 0 0 0 103.0144-52.3264c3.4304-3.4816 12.0832-2.304 17.8176-2.304z m51.2-108.1856c25.344 0 48.896 16.6912 54.1184 43.1616 6.8608 39.68 24.1664 74.24 52.3264 102.9632 3.4816 3.4816 1.1776 13.2608 2.304 18.9952-6.912 0-15.5136 2.304-18.944-1.1264-28.8256-29.952-64.512-45.4656-104.192-54.0672a53.6576 53.6576 0 0 1-40.8064-58.7264c3.9936-28.7232 26.4704-50.0224 55.1936-51.2z" p-id="26452" fill="currentColor"></path></svg>',
    feishu: '<svg class="prefix__prefix__icon" viewBox="0 0 1024 1024" fill="currentColor" width="200" height="200"><path d="M48.762 435.81v9.508l.731 248.198-.365 49.372.365 21.162.366 7.412.731 4.925v.707c0 .341 0 .707.342 1.048 1.463 5.998 5.095 10.948 10.532 15.872 4.706 4.243 10.509 7.754 19.578 12.679 43.155 22.918 84.529 39.862 126.976 51.492 43.545 11.996 88.893 18.335 137.509 19.383 50.42 1.073 97.207-3.877 142.921-15.506 43.886-10.923 87.43-27.502 133.486-50.761 34.133-17.287 71.485-44.423 105.57-76.508l11.97-11.654 11.63-11.971 4.706-5.29-2.536 1.413-9.801 4.925-3.633 1.78c-38.449 17.262-78.36 22.187-122.978 16.92l-13.409-1.78-13.41-2.437-3.291-.732-3.267-.707-14.141-3.17-3.633-1.048-3.974-1.072-16.335-4.584-2.926-.707c-1.78-.683-3.974-1.049-5.778-1.756l-29.745-9.167-14.507-4.583-42.447-14.8-21.04-7.753-19.237-6.339-9.436-3.9-10.142-4.584-1.097-.342c-1.097-.365-1.804-1.073-2.926-1.755l-13.775-6.705-35.913-16.579-22.48-10.923-7.972-4.242c-40.277-20.431-79.823-45.105-119.37-72.972A1362.651 1362.651 0 0173.07 457.338l-18.871-17.31-5.437-4.194z"/><path d="M851.456 390.095l-14.75.39-5.681.39a320.853 320.853 0 00-66.243 10.801c-19.7 5.413-39.01 12.727-57.54 22.382-18.943 9.655-36.717 20.846-53.394 33.963l-9.46 7.338-2.267 1.95-2.267 1.902-9.07 8.12-9.484 8.874-10.582 10.045-49.98 49.396-3.414 3.096c-24.21 23.162-42.008 38.595-62.83 53.248l-8.313 5.803-21.578 14.287-3.023 1.926a462.676 462.676 0 01-11.751 7.314l-10.972 6.193 15.897 6.559 46.567 17.749 28.77 10.435 32.548 10.8 18.53 5.779 16.286 4.632 3.804 1.17c3.779 1.147 7.558 1.927 10.971 2.683l13.995 3.096 3.413.78 3.413.78 13.24 2.317 3.413.365 3.413.39c43.886 5.413 82.895 0 120.369-18.53 48.079-23.527 70.778-47.859 102.205-106.91l10.215-19.675 16.287-32.427 7.192-13.897 2.268-4.242c21.942-42.472 38.595-68.316 61.318-92.258l2.267-2.316-5.29-1.926-6.437-2.316-13.653-4.633-11.703-3.462-5.315-1.56a319.195 319.195 0 00-66.243-9.655l-15.117-1.146zM219.429 170.667l12.434 9.947 17.871 14.36 7.314 5.974a1493.163 1493.163 0 0159.149 51.785 1033.582 1033.582 0 0177.043 81.262 1258.033 1258.033 0 0160.27 75.312 1085.684 1085.684 0 0140.911 58.954l15.336 24.697 24.844 43.423 15.701-15.945 23.723-24.698 13.507-13.946 17.896-17.92 4.023-3.974c11.312-11.167 23.381-21.528 35.425-31.476 9.85-7.972 21.553-15.945 34.694-23.503 9.143-5.193 18.262-9.972 27.746-14.336l15.701-6.778 8.412-3.17-.366-1.219-.366-1.999a224.792 224.792 0 00-9.85-31.451l-6.217-16.75-1.463-3.584c-9.85-24.698-21.553-50.2-30.305-66.121l-17.896-29.891-9.874-15.53-1.804-2.39c-13.166-19.92-23.747-32.28-32.525-36.645-5.851-3.194-11.312-3.998-20.43-4.388H219.428z"/></svg>',
    dingtalk: '<svg t="1767201582474" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="25264" width="200" height="200"><path d="M879.36 393.813a174.933 174.933 0 0 1-11.307 29.014v1.28c-32.853 70.186-118.4 208-118.4 208l-24.96 42.666h120.534l-231.04 306.56 52.266-208.64H571.52l32.853-138.026c-26.666 6.4-58.24 15.36-95.573 27.306 0 0-50.56 29.654-145.493-56.96 0 0-64-56.533-26.88-70.613a1098.24 1098.24 0 0 1 124.586-20.053c64-8.747 104.534-13.44 104.534-13.44s-199.68 2.986-247.04-4.48-106.667-86.614-120.32-156.16c0 0-19.84-38.187 42.666-20.054s320 70.4 320 70.4-335.786-103.04-357.973-128S137.813 124.8 143.36 56.107a15.147 15.147 0 0 1 20.053-13.44S411.52 156.16 581.333 218.453s317.227 94.72 298.027 175.36z" p-id="25265" fill="currentColor"></path></svg>',
    link: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>',
    sun: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>',
    moon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>',
    check: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="20 6 9 17 4 12"></polyline></svg>'
};

const TypeIcons = {
    info: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color:var(--focus-ring)"><circle cx="12" cy="12" r="10"/><line x1="12" y1="11" x2="12" y2="18"/><circle cx="12" cy="7" r="0.4"/></svg>',
    success: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color:var(--success)"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
    warning: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color:var(--warning)"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/><circle cx="12" cy="17" r="0.5"/></svg>',
    error: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color:var(--danger)"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>'
};

const FormatIcons = {
    text: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24""><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>',
    markdown: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="18" height="14" rx="2" ry="2"></rect><path d="M9 15V9l3 3 3-3v6"></path></svg>',
    html: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>'
};

class ChipInput {
    constructor(containerId, inputId, storageKey) {
        this.container = document.getElementById(containerId);
        this.input = document.getElementById(inputId);
        this.items = [];
        this.storageKey = storageKey;
        this.init();
    }

    init() {
        this.input.addEventListener('keydown', (e) => this.handleKey(e));
        this.input.addEventListener('paste', (e) => this.handlePaste(e));
        this.input.addEventListener('blur', () => this.addItemFromInput());

        // Focus container -> focus input
        this.container.onclick = (e) => {
            if (e.target === this.container) this.input.focus();
        }

        const saved = localStorage.getItem(this.storageKey);
        if (saved) {
            try {
                this.items = JSON.parse(saved);
            } catch {
                this.items = saved.split(',').filter(s => s);
            }
        }
        this.render();
    }

    handleKey(e) {
        if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            this.addItemFromInput();
        } else if (e.key === 'Backspace' && this.input.value === '' && this.items.length > 0) {
            this.items.pop();
            this.saveAndRender();
        }
    }

    handlePaste(e) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text');
        const parts = text.split(/,|\n/);
        parts.forEach(p => this.addItem(p));
    }

    addItemFromInput() {
        const val = this.input.value.trim();
        if (val) {
            this.addItem(val);
            this.input.value = '';
        }
    }

    addItem(text) {
        text = text.trim().replace(/^['"]|['"]$/g, '');
        if (text && !this.items.includes(text)) {
            this.items.push(text);
            this.saveAndRender();
        }
    }

    deleteItem(index) {
        this.items.splice(index, 1);
        this.saveAndRender();
    }

    updateItem(index, newVal) {
        if (newVal && newVal.trim()) {
            this.items[index] = newVal.trim();
        }
        this.saveAndRender();
    }

    saveAndRender() {
        localStorage.setItem(this.storageKey, JSON.stringify(this.items));
        this.render();
    }

    getIcon(text) {
        const lower = text.toLowerCase();
        if (lower.startsWith('tgram')) return Icons.telegram;
        if (lower.startsWith('twitter') || lower.startsWith('x')) return Icons.x;
        if (lower.startsWith('whatsapp')) return Icons.whatsapp;
        if (lower.startsWith('line')) return Icons.line;
        if (lower.startsWith('slack')) return Icons.slack;
        if (lower.startsWith('discord')) return Icons.discord;
        if (lower.startsWith('bark')) return Icons.bark;
        if (lower.startsWith('dingtalk')) return Icons.dingtalk;
        if (lower.startsWith('wecom')) return Icons.wecom;
        if (lower.startsWith('qq')) return Icons.qq;
        if (lower.startsWith('feishu')) return Icons.feishu;
        if (lower.startsWith('ntfy')) return Icons.ntfy;
        if (lower.startsWith('mail')) return Icons.mail;
        return Icons.link;
    }

    render() {
        const chips = this.container.querySelectorAll('.chip');
        chips.forEach(c => c.remove());

        this.items.forEach((text, index) => {
            const chip = document.createElement('div');
            chip.className = 'chip';

            chip.innerHTML = this.getIcon(text);

            // Editable Span
            const span = document.createElement('span');
            span.className = 'chip-text';
            span.innerText = text;
            span.contentEditable = true;

            // 禁用拼写检查、自动更正、自动大写（iOS/Android/桌面全兼容）
            span.setAttribute('spellcheck', 'false');
            span.setAttribute('autocorrect', 'off');
            span.setAttribute('autocapitalize', 'off');

            span.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    span.blur();
                }
            };
            span.onblur = () => {
                if (span.innerText !== text) {
                    this.updateItem(index, span.innerText);
                }
            };
            span.onclick = (e) => e.stopPropagation();

            chip.appendChild(span);

            const close = document.createElement('span');
            close.className = 'chip-close';
            close.innerText = '×';
            close.onclick = (e) => {
                e.stopPropagation();
                this.deleteItem(index);
            };
            chip.appendChild(close);

            this.container.insertBefore(chip, this.input);
        });
    }

    getValue() { return this.items.join(','); }
    setValue(arr) { this.items = arr; this.saveAndRender(); }
}

const app = {
    urlInput: null,
    currentLang: 'zh-CN',

    init() {
        this.initLang();
        this.initTheme();
        this.urlInput = new ChipInput('urlContainer', 'urlInput', 'apprise_urls');

        // Auto API URL
        const apiUrl = window.location.protocol.startsWith('http') ? window.location.origin + '/notify' : 'http://host:port/notify';
        document.getElementById('apiUrlText').innerText = apiUrl;

        // Restore Inputs
        ['title', 'body'].forEach(id => {
            const el = document.getElementById(id);
            const val = localStorage.getItem('apprise_' + id);
            if (val) el.value = val;
            // Bind save events
            el.addEventListener('input', () => this.saveInput(id));
        });

        // Setup Buttons
        document.getElementById('themeBtn').addEventListener('click', () => this.toggleTheme());

        // Language Dropdown
        document.getElementById('langTrigger').addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleLangMenu();
        });

        document.getElementById('sendBtn').addEventListener('click', () => this.send());
        document.getElementById('copyBtn').addEventListener('click', () => this.copyCurl());
        document.getElementById('clearHistoryBtn').addEventListener('click', () => this.clearHistory());
        document.getElementById('apiBox').addEventListener('click', () => this.copyApiUrl());

        // Form Selects
        document.getElementById('typeTrigger').addEventListener('click', (e) => {
            e.stopPropagation(); // 阻止冒泡
            this.toggleTypeSelect();
        });
        document.getElementById('formatTrigger').addEventListener('click', (e) => {
            e.stopPropagation(); // 阻止冒泡
            this.toggleFormatSelect();
        });

        // Initialize Selects
        this.initTypeSelect();
        this.initFormatSelect();

        // Global click to close ALL dropdowns
        document.addEventListener('click', () => {
            document.getElementById('typeOptions').classList.remove('open');
            document.getElementById('formatOptions').classList.remove('open');
            document.getElementById('langOptions').classList.remove('open');
        });

        this.renderHistory();
    },

    // --- 国际化功能 ---
    initLang() {
        const saved = localStorage.getItem('language');
        if (saved && TRANSLATIONS[saved]) {
            this.currentLang = saved;
        } else {
            // 简单检测浏览器语言
            const navLang = navigator.language || navigator.userLanguage;
            if (navLang.startsWith('en')) this.currentLang = 'en';
            else if (navLang.startsWith('ja')) this.currentLang = 'ja';
            else this.currentLang = 'zh-CN';
        }
        this.applyLanguage(this.currentLang);
        this.renderLangMenu();
    },

    toggleLangMenu() {
        // 关闭其他下拉菜单
        document.getElementById('typeOptions').classList.remove('open');
        document.getElementById('formatOptions').classList.remove('open');
        document.getElementById('langOptions').classList.toggle('open');
    },

    renderLangMenu() {
        const container = document.getElementById('langOptions');
        container.innerHTML = '';
        Object.keys(TRANSLATIONS).forEach(key => {
            const div = document.createElement('div');
            // 添加 .selected 类如果当前语言匹配
            const isSelected = key === this.currentLang;
            div.className = `custom-option ${isSelected ? 'selected' : ''}`;

            // 名称 + 选中时的勾选图标
            div.innerHTML = `
                <span>${LANG_NAMES[key] || key}</span>
                <span class="check-icon">${Icons.check}</span>
            `;

            div.onclick = (e) => {
                e.stopPropagation();
                this.applyLanguage(key);
                document.getElementById('langOptions').classList.remove('open');
            };
            container.appendChild(div);
        });
    },

    applyLanguage(lang) {
        this.currentLang = lang;
        localStorage.setItem('language', lang);
        document.documentElement.setAttribute('lang', lang);

        const t = TRANSLATIONS[lang];

        // 1. 处理 data-i18n (innerText)
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (t[key]) el.innerText = t[key];
        });

        // 2. 处理 data-i18n-placeholder
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.getAttribute('data-i18n-placeholder');
            if (t[key]) el.placeholder = t[key];
        });

        // 3. 处理 data-i18n-title (tooltip)
        document.querySelectorAll('[data-i18n-title]').forEach(el => {
            const key = el.getAttribute('data-i18n-title');
            if (t[key]) el.title = t[key];
        });

        // 4. 更新动态组件 (Type & Format Selects)
        this.updateTypeSelectLabel();
        this.updateFormatSelectLabel();
        // 重新渲染下拉列表以更新语言
        this.renderTypeOptions();
        this.renderFormatOptions();
        // 重新渲染语言菜单以更新选中状态
        this.renderLangMenu();
    },

    t(key) {
        return TRANSLATIONS[this.currentLang][key] || key;
    },
    // -----------------

    initTypeSelect() {
        const savedType = localStorage.getItem('apprise_type') || 'info';
        // 设置隐藏 input 的值
        document.getElementById('type').value = savedType;
        // 渲染选项
        this.renderTypeOptions();
        // 更新显示标签
        this.updateTypeSelectLabel();
    },

    renderTypeOptions() {
        const container = document.getElementById('typeOptions');
        container.innerHTML = ''; // clear
        Object.keys(TypeIcons).forEach(key => {
            const div = document.createElement('div');
            div.className = 'custom-option';

            // 获取翻译文本
            const label = this.t('opt_' + key);

            div.innerHTML = `${TypeIcons[key]} ${label}`;
            div.onclick = () => this.setType(key);
            container.appendChild(div);
        });
    },

    initFormatSelect() {
        const saved = localStorage.getItem('apprise_format') || 'text';
        document.getElementById('format').value = saved;
        this.renderFormatOptions();
        this.updateFormatSelectLabel();
    },

    renderFormatOptions() {
        const container = document.getElementById('formatOptions');
        container.innerHTML = '';
        Object.keys(FormatIcons).forEach(key => {
            const div = document.createElement('div');
            div.className = 'custom-option';

            let label = key === 'html' ? 'HTML' : key.charAt(0).toUpperCase() + key.slice(1);

            div.innerHTML = `${FormatIcons[key]} ${label}`;
            div.onclick = (e) => {
                e.stopPropagation();
                this.setFormat(key);
            };
            container.appendChild(div);
        });
    },

    initTheme() {
        const saved = localStorage.getItem('theme');
        const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let mode = 'light';
        if (saved === 'dark') mode = 'dark';
        else if (saved === 'light') mode = 'light';
        else if (systemDark) mode = 'dark';

        this.applyTheme(mode);

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (!localStorage.getItem('theme')) {
                this.applyTheme(e.matches ? 'dark' : 'light');
            }
        });
    },

    toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', next);
        this.applyTheme(next);
    },

    applyTheme(mode) {
        if (mode === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        } else {
            document.documentElement.removeAttribute('data-theme');
        }
        const btn = document.getElementById('themeBtn');
        if (btn) btn.innerHTML = mode === 'dark' ? Icons.sun : Icons.moon;

        const metaTag = document.querySelector('meta[name="theme-color"]');
        if (metaTag) metaTag.setAttribute('content', mode === 'dark' ? '#1c1c1e' : '#ffffff');
    },

    toggleTypeSelect() {
        document.getElementById('formatOptions').classList.remove('open');
        document.getElementById('langOptions').classList.remove('open');
        document.getElementById('typeOptions').classList.toggle('open');
    },

    toggleFormatSelect() {
        document.getElementById('typeOptions').classList.remove('open');
        document.getElementById('langOptions').classList.remove('open');
        document.getElementById('formatOptions').classList.toggle('open');
    },

    setType(val) {
        document.getElementById('type').value = val;
        this.updateTypeSelectLabel();
        document.getElementById('typeOptions').classList.remove('open');
        localStorage.setItem('apprise_type', val);
    },

    updateTypeSelectLabel() {
        const val = document.getElementById('type').value;
        const label = this.t('opt_' + val);
        document.getElementById('typeDisplay').innerHTML = TypeIcons[val] + ' ' + label;
    },

    setFormat(val) {
        document.getElementById('format').value = val;
        this.updateFormatSelectLabel();
        document.getElementById('formatOptions').classList.remove('open');
        this.saveInput('format');
    },

    updateFormatSelectLabel() {
        const val = document.getElementById('format').value;
        let label = val === 'html' ? 'HTML' : val.charAt(0).toUpperCase() + val.slice(1);
        document.getElementById('formatDisplay').innerHTML = FormatIcons[val] + ' ' + label;
    },

    saveInput(id) {
        localStorage.setItem('apprise_' + id, document.getElementById(id).value);
    },

    copyApiUrl() {
        const url = document.getElementById('apiUrlText').innerText;
        navigator.clipboard.writeText(url).then(() => {
            // 修改：限定选择器范围，只获取 API Box 里的提示元素
            const hint = document.querySelector('#apiBox .copy-hint');
            const originalText = hint.innerText;
            hint.innerText = this.t('msg_copied');
            hint.style.color = "var(--success)";
            setTimeout(() => {
                hint.innerText = this.t('hint_click_copy'); // reset to translation
                hint.style.color = "";
            }, 1500);
        });
    },

    async send() {
        const rawTitle = document.getElementById('title').value;
        const rawBody = document.getElementById('body').value;
        const typeVal = document.getElementById('type').value;

        // 获取当前语言环境下的默认值
        const defaultTitle = this.t('placeholder_title');
        const defaultBody = this.t('placeholder_body');

        const payload = {
            urls: this.urlInput.getValue(),
            type: typeVal,
            format: document.getElementById('format').value,
            title: rawTitle.trim() || defaultTitle,
            body: rawBody.trim() || defaultBody
        };

        if (!payload.urls) {
            alert(this.t('msg_no_url'));
            return;
        }

        const btn = document.getElementById('sendBtn');
        const resArea = document.getElementById('resultArea');

        btn.classList.add('loading');
        btn.disabled = true;
        resArea.innerText = 'Sending...';
        resArea.className = '';

        try {
            const res = await fetch('/notify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            resArea.innerText = JSON.stringify(data, null, 2);
            if (res.ok) {
                resArea.classList.add('response-ok');
                this.addToHistory(payload);
            } else {
                resArea.classList.add('response-err');
            }
        } catch (e) {
            resArea.innerText = 'Error: ' + e.message;
            resArea.classList.add('response-err');
        } finally {
            btn.classList.remove('loading');
            btn.disabled = false;
        }
    },

    addToHistory(payload) {
        const history = JSON.parse(localStorage.getItem('apprise_history') || '[]');
        payload._time = new Date().toLocaleTimeString();
        history.unshift(payload);
        if (history.length > 30) history.pop();
        localStorage.setItem('apprise_history', JSON.stringify(history));
        this.renderHistory();
    },

    renderHistory() {
        const list = document.getElementById('historyList');
        const history = JSON.parse(localStorage.getItem('apprise_history') || '[]');

        list.innerHTML = history.map((item, idx) => `
          <div class="history-item" onclick="app.restore(${idx})">
            <div class="h-top">
              <span>${item._time}</span>
              <span>${item.type}</span>
            </div>
            <div class="h-title">${item.title}</div>
            <div class="h-preview">${item.body}</div>
          </div>
        `).join('');
    },

    restore(index) {
        const history = JSON.parse(localStorage.getItem('apprise_history') || '[]');
        const item = history[index];
        if (!item) return;

        this.urlInput.setValue(item.urls ? item.urls.split(',') : []);

        this.setType(item.type);
        this.setFormat(item.format);

        document.getElementById('title').value = item.title;
        document.getElementById('body').value = item.body;

        this.saveInput('title');
        this.saveInput('body');
    },

    clearHistory() {
        if (confirm(this.t('msg_clear_history'))) {
            localStorage.removeItem('apprise_history');
            this.renderHistory();
        }
    },

    copyCurl() {
        const defaultTitle = this.t('placeholder_title');
        const defaultBody = this.t('placeholder_body');
        const payload = {
            urls: this.urlInput.getValue(),
            title: document.getElementById('title').value || defaultTitle,
            body: document.getElementById('body').value || defaultBody,
            type: document.getElementById('type').value,
            format: document.getElementById('format').value
        };
        const cmd = `curl -X POST "${location.origin}/notify" -H "Content-Type: application/json" -d '${JSON.stringify(payload)}'`;

        navigator.clipboard.writeText(cmd).then(() => {
            const btn = document.getElementById('copyBtn');
            const span = btn.querySelector('span');
            const originalText = span.innerText;

            span.innerText = this.t('msg_copied');
            btn.classList.add('btn-copied');

            setTimeout(() => {
                span.innerText = originalText;
                btn.classList.remove('btn-copied');
                this.applyLanguage(this.currentLang);
            }, 1000);
        });
    }
};

document.addEventListener('DOMContentLoaded', () => app.init());